---
import { buildShiftAscii } from "../lib/aaCore.ts";

const DEFAULT_FROM_YEAR = "2025";
const DEFAULT_TO_YEAR = "2026";

const INITIAL_ASCII = buildShiftAscii(DEFAULT_FROM_YEAR, DEFAULT_TO_YEAR);
---

<section class="generator">
  <style>
    .generator {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      align-items: center;
      text-align: center;
    }
    .panel {
      background: #f4f5f7;
      border-radius: 12px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
      text-align: center;
      width: 100%;
    }
    .year-inputs {
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    .digit-input {
      width: 3.5rem;
      padding: 0.5rem;
      font-size: 1.5rem;
      text-align: center;
      border: 1px solid #cbd5f5;
      border-radius: 8px;
      font-family: monospace;
    }
    .year-input {
      width: 6rem;
      letter-spacing: 0.08em;
    }
    .arrow {
      font-size: 1.2rem;
      font-weight: 700;
      color: #111827;
      padding: 0 0.25rem;
      user-select: none;
      text-align: center;
    }
    .ascii-panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
      text-align: center;
    }
    .ascii-panel.is-disabled .ascii-block {
      opacity: 0.55;
    }
    .ascii-block {
      background: #111827;
      color: #f9fafb;
      padding: 1rem;
      border-radius: 12px;
      font-family:
        ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 1rem;
      line-height: 1.2;
      white-space: pre;
      overflow-x: auto;
      display: inline-block;
      margin: 0 auto;
      letter-spacing: 0;
      font-kerning: none;
      font-variant-ligatures: none;
      font-feature-settings:
        "liga" 0,
        "calt" 0;
    }
    .actions {
      display: flex;
      gap: 0.75rem;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .actions button {
      padding: 0.6rem 1rem;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: #f9fafb;
      font-weight: 600;
      cursor: pointer;
    }
    .actions button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .status {
      font-size: 0.85rem;
    }
    input {
      width: 5em;
    }
    .aa-output {
      white-space: pre;
    }
  </style>
  <div class="panel">
    <h2>年号を入力</h2>
    <div class="year-inputs" aria-label="年号入力（元→先）">
      <input
        id="from-year"
        class="digit-input year-input"
        inputmode="numeric"
        pattern="[0-9]{4}"
        maxlength={4}
        placeholder={DEFAULT_FROM_YEAR}
        value={DEFAULT_FROM_YEAR}
        aria-label="古い年号（4桁の数字）"
      />
      <span class="arrow" aria-hidden="true">→</span>
      <input
        id="to-year"
        class="digit-input year-input"
        inputmode="numeric"
        pattern="[0-9]{4}"
        maxlength={4}
        placeholder={DEFAULT_TO_YEAR}
        value={DEFAULT_TO_YEAR}
        aria-label="新しい年号（4桁の数字）"
      />
    </div>
  </div>
  <div class="panel ascii-panel">
    <h2>生成結果</h2>
    <pre
      class="ascii-block"
      id="ascii-output"
      aria-label="年号シフトのASCIIアート"
      data-from-year={DEFAULT_FROM_YEAR}
      data-to-year={DEFAULT_TO_YEAR}>{INITIAL_ASCII}</pre>
    <div class="actions">
      <button type="button" id="copy-button">コピー</button>
      <span class="status" id="copy-status" role="status"></span>
    </div>
  </div>
  <script>
    import { buildShiftAscii } from "../lib/aaCore.ts";

    const generator = document.querySelector(".generator");

    if (!generator) {
      console.error("初期化に失敗しました。");
    } else {
      const sanitizeYear = (value: string): string =>
        value.replace(/\D/g, "").slice(0, 4);
      const isYear4 = (value: string): boolean =>
        typeof value === "string" && /^[0-9]{4}$/.test(value);

      const fromInput = document.getElementById(
        "from-year",
      ) as HTMLInputElement | null;
      const toInput = document.getElementById(
        "to-year",
      ) as HTMLInputElement | null;
      const outputField = document.getElementById(
        "ascii-output",
      ) as HTMLPreElement | null;
      const asciiPanel = outputField?.closest(
        ".ascii-panel",
      ) as HTMLElement | null;
      const copyButton = document.getElementById(
        "copy-button",
      ) as HTMLButtonElement | null;
      const copyStatus = document.getElementById(
        "copy-status",
      ) as HTMLSpanElement | null;

      const defaultFromYear = outputField?.dataset.fromYear ?? "2025";
      const defaultToYear = outputField?.dataset.toYear ?? "2026";

      let fromYear = defaultFromYear;
      let toYear = defaultToYear;
      let copyResetHandle: number | null = null;
      let lastValidAscii = (outputField?.textContent ?? "").trimEnd();

      const updateCopyStatus = (
        message: string | null,
        isError: boolean = false,
      ): void => {
        if (!copyStatus) {
          return;
        }
        copyStatus.textContent = message || "";
        copyStatus.dataset.state = isError ? "error" : "success";
        if (copyResetHandle) {
          window.clearTimeout(copyResetHandle);
        }
        if (message) {
          copyResetHandle = window.setTimeout(() => {
            if (copyStatus) {
              copyStatus.textContent = "";
              delete copyStatus.dataset.state;
            }
          }, 2000);
        }
      };

      const setOutputDisabled = (disabled: boolean): void => {
        if (asciiPanel instanceof HTMLElement) {
          asciiPanel.classList.toggle("is-disabled", disabled);
        }
        if (outputField instanceof HTMLElement) {
          outputField.setAttribute(
            "aria-disabled",
            disabled ? "true" : "false",
          );
        }
      };

      const updateOutput = (): void => {
        const canRender = isYear4(fromYear) && isYear4(toYear);

        if (!canRender) {
          setOutputDisabled(true);
          if (copyButton) {
            copyButton.disabled = !lastValidAscii;
          }
          return;
        }

        const ascii = buildShiftAscii(fromYear, toYear);
        const isValid = Boolean(ascii);
        if (isValid) {
          lastValidAscii = ascii;
        }
        if (outputField && lastValidAscii) {
          outputField.textContent = lastValidAscii;
        }
        setOutputDisabled(false);
        if (copyButton) {
          copyButton.disabled = !isValid;
        }
      };

      fromInput?.addEventListener("input", (event: Event): void => {
        const input = event.target;
        if (!(input instanceof HTMLInputElement)) {
          return;
        }
        const value = sanitizeYear(input.value || "");
        input.value = value;
        fromYear = value;
        updateOutput();
      });

      toInput?.addEventListener("input", (event: Event): void => {
        const input = event.target;
        if (!(input instanceof HTMLInputElement)) {
          return;
        }
        const value = sanitizeYear(input.value || "");
        input.value = value;
        toYear = value;
        updateOutput();
      });

      copyButton?.addEventListener("click", async (): Promise<void> => {
        const ascii = buildShiftAscii(fromYear, toYear) || lastValidAscii;
        if (!ascii) {
          updateCopyStatus(
            "コピーに失敗しました。ブラウザの権限をご確認ください。",
            true,
          );
          return;
        }
        try {
          if (!navigator.clipboard) {
            throw new Error("Clipboard unavailable");
          }
          await navigator.clipboard.writeText(ascii);
          updateCopyStatus("コピーしました！");
        } catch (error) {
          console.error(error);
          updateCopyStatus(
            "コピーに失敗しました。ブラウザの権限をご確認ください。",
            true,
          );
        }
      });

      updateOutput();
    }
  </script>
</section>
